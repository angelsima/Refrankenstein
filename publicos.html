<!DOCTYPE html>
<html lang="es">
<head>
    <!-- ... (Estilos permanecen igual) ... -->
</head>
<body>
    <!-- ... (HTML permanece igual hasta la paginaci√≥n) ... -->
    
    <!-- Paginaci√≥n -->
    <div class="pagination">
        <button id="prev-page" disabled>‚Üê </button>
        <div id="page-numbers"></div>
        <button id="next-page"> ‚Üí</button>
    </div>

    <!-- ... (Resto del HTML permanece igual) ... -->

<script>
    // Configuraci√≥n de Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyAdoPUF-cCyvpfiCJiBfCRv3ZYtwu1W4tc",
        authDomain: "refrankenstein.firebaseapp.com",
        projectId: "refrankenstein",
        storageBucket: "refrankenstein.firebasestorage.app",
        messagingSenderId: "575434538832",
        appId: "1:575434538832:web:615f850a61c54ddd9d3655"
    };

    // Inicializaci√≥n de Firebase
    try {
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // Variables globales
        let currentFilter = 'nuevos';
        let currentPage = 1;
        const refranesPerPage = 25;
        let totalRefranes = 0;
        let totalPages = 1;
        let lastVisible = null;
        let paginationData = {};

        // Funci√≥n para votar (sin cambios)
        function votarRefran(refranId, votosActuales) {
            const nuevoVoto = votosActuales + 1;
            db.collection('refranes').doc(refranId).update({ votos: nuevoVoto })
                .then(() => {
                    document.querySelectorAll(`[data-refran-id="${refranId}"] .vote-count`)
                        .forEach(el => el.textContent = nuevoVoto);
                })
                .catch(error => console.error("Error al votar:", error));
        }

        // Funci√≥n para filtrar (actualizada)
        function filtrarRefranes(tipo) {
            currentFilter = tipo;
            currentPage = 1;
            lastVisible = null;
            paginationData = {};
            document.querySelectorAll('.filter-btn').forEach(btn => 
                btn.classList.toggle('active', btn.dataset.filter === tipo));
            cargarRefranes();
        }

        // Funci√≥n principal para cargar refranes (revisada)
        async function cargarRefranes() {
            const listaRefranes = document.getElementById('lista-refranes');
            const loadingElement = document.getElementById('loading');
            
            loadingElement.style.display = 'block';
            listaRefranes.innerHTML = '';

            try {
                let query = db.collection('refranes');
                
                // Aplicar ordenamiento
                if (currentFilter === 'populares') query = query.orderBy('votos', 'desc');
                else if (currentFilter === 'alfabetico') query = query.orderBy('texto', 'asc');
                else query = query.orderBy('fecha', 'desc');
                
                // Manejo de paginaci√≥n
                if (currentPage === 1) {
                    query = query.limit(refranesPerPage);
                } else {
                    const lastDoc = paginationData[currentFilter]?.[currentPage - 1];
                    if (lastDoc) query = query.startAfter(lastDoc).limit(refranesPerPage);
                }

                const querySnapshot = await query.get();
                const docs = querySnapshot.docs;
                
                // Actualizar datos de paginaci√≥n
                if (docs.length > 0) {
                    if (!paginationData[currentFilter]) paginationData[currentFilter] = {};
                    paginationData[currentFilter][currentPage] = docs[docs.length - 1];
                    lastVisible = docs[docs.length - 1];
                }

                // Obtener total de refranes (solo primera vez)
                if (currentPage === 1) {
                    const totalSnapshot = await db.collection('refranes').count().get();
                    totalRefranes = totalSnapshot.data().count;
                    totalPages = Math.ceil(totalRefranes / refranesPerPage);
                }

                // Mostrar refranes
                const uniqueRefranes = [];
                const seenTexts = new Set();
                
                docs.forEach(doc => {
                    const data = doc.data();
                    if (!seenTexts.has(data.texto)) {
                        seenTexts.add(data.texto);
                        uniqueRefranes.push({ id: doc.id, ...data });
                    }
                });

                listaRefranes.innerHTML = uniqueRefranes.map(refran => `
                    <div class="refran-container" data-refran-id="${refran.id}">
                        <p class="refran-text">${refran.texto}</p>
                        <div class="voting-container">
                            <button class="vote-btn" onclick="votarRefran('${refran.id}', ${refran.votos || 0})">
                                üëç <span class="vote-count">${refran.votos || 0}</span>
                            </button>
                        </div>
                        <small class="refran-date">
                            ${refran.fecha?.toDate?.().toLocaleDateString('es-ES') || 'Fecha desconocida'}
                        </small>
                    </div>
                `).join('');

                updatePaginationControls();
            } catch (error) {
                console.error("Error al cargar refranes:", error);
                document.getElementById('error-message').textContent = 
                    `Error al cargar refranes: ${error.message}`;
            } finally {
                loadingElement.style.display = 'none';
            }
        }

        // Funci√≥n para actualizar controles de paginaci√≥n (corregida)
        function updatePaginationControls() {
            const prevBtn = document.getElementById('prev-page');
            const nextBtn = document.getElementById('next-page');
            const pageNumbers = document.getElementById('page-numbers');
            
            prevBtn.disabled = currentPage === 1;
            nextBtn.disabled = currentPage === totalPages || totalPages === 0;
            
            // Generar n√∫meros de p√°gina
            pageNumbers.innerHTML = '';
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);
            
            if (startPage > 1) {
                addPageNumber(1);
                if (startPage > 2) pageNumbers.innerHTML += '<span>...</span>';
            }
            
            for (let i = startPage; i <= endPage; i++) {
                addPageNumber(i);
            }
            
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) pageNumbers.innerHTML += '<span>...</span>';
                addPageNumber(totalPages);
            }
        }

        // Funci√≥n auxiliar para n√∫meros de p√°gina
        function addPageNumber(page) {
            const pageElement = document.createElement('span');
            pageElement.className = `page-number ${page === currentPage ? 'active' : ''}`;
            pageElement.textContent = page;
            pageElement.onclick = () => goToPage(page);
            document.getElementById('page-numbers').appendChild(pageElement);
        }

        // Funci√≥n para cambiar de p√°gina (actualizada)
        function goToPage(page) {
            if (page < 1 || page > totalPages || page === currentPage) return;
            
            // Validar si tenemos el documento de referencia necesario
            if (page > currentPage && !paginationData[currentFilter]?.[currentPage]) {
                console.warn("No hay datos de paginaci√≥n para esta p√°gina");
                return;
            }
            
            currentPage = page;
            cargarRefranes();
        }

        // Event Listeners
        document.getElementById('prev-page').addEventListener('click', () => goToPage(currentPage - 1));
        document.getElementById('next-page').addEventListener('click', () => goToPage(currentPage + 1));
        document.querySelectorAll('.filter-btn').forEach(btn => 
            btn.addEventListener('click', () => filtrarRefranes(btn.dataset.filter)));

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', () => {
            cargarRefranes();
            db.collection('refranes').onSnapshot(() => 
                document.getElementById('refranes-counter').textContent = totalRefranes);
        });

    } catch (error) {
        console.error("Error al inicializar Firebase:", error);
        document.getElementById('loading').style.display = 'none';
        document.getElementById('error-message').textContent = 
            `Error cr√≠tico: ${error.message}. Recarga la p√°gina o intenta m√°s tarde.`;
    }
</script>
</body>
</html>
