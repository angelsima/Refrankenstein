<script>
    // Configuraci√≥n Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyAdoPUF-cCyvpfiCJiBfCRv3ZYtwu1W4tc",
        authDomain: "refrankenstein.firebaseapp.com",
        projectId: "refrankenstein",
        storageBucket: "refrankenstein.firebasestorage.app",
        messagingSenderId: "575434538832",
        appId: "1:575434538832:web:615f850a61c54ddd9d3655"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Variables globales
    let refranes = [];
    let rematesDisponibles = [];
    let respuestaCorrecta;
    let refranesCargados = false;

    // Funci√≥n para mostrar notificaciones
    function showToast(message, duration = 3000) {
        const toast = document.getElementById('custom-toast');
        document.getElementById('toast-message').textContent = message;
        toast.classList.add('toast-visible');
        setTimeout(() => toast.classList.remove('toast-visible'), duration);
    }

    // Funci√≥n para ordenar refranes
    function ordenarRefranes(refranes) {
        return refranes.sort((a, b) => {
            const textoA = a.completo?.toLowerCase() || '';
            const textoB = b.completo?.toLowerCase() || '';
            return textoA.localeCompare(textoB, 'es', { 
                sensitivity: 'base',
                ignorePunctuation: true
            });
        });
    }

    // Cargar datos de Firebase
    async function cargarDatos() {
        try {
            const snapshot = await db.collection('tradicionales').get();
            refranes = snapshot.docs
                .map(doc => {
                    const data = doc.data();
                    if(data.inicio?.trim() && data.remate?.trim() && data.completo?.trim()) {
                        return {
                            inicio: data.inicio.trim(),
                            remate: data.remate.trim(),
                            completo: data.completo.trim()
                        };
                    }
                    return null;
                })
                .filter(item => item !== null);

            if(refranes.length === 0) {
                showToast('No se encontraron refranes', 5000);
                return [];
            }

            refranes = ordenarRefranes(refranes);
            rematesDisponibles = [...new Set(refranes.map(r => r.remate))]; // Eliminar remates duplicados

            if(document.getElementById('modo-juego').classList.contains('activo')) {
                nuevoRefran();
            }

            return refranes;
        } catch (error) {
            console.error('Error:', error);
            showToast('Error cargando datos', 5000);
            return [];
        }
    }

    // Modo Juego
    function nuevoRefran() {
        if(refranes.length === 0) return;
        
        document.getElementById('nuevo-btn').style.display = 'none';
        const opcionesContainer = document.getElementById('opciones-container');
        opcionesContainer.innerHTML = '';

        const refran = refranes[Math.floor(Math.random() * refranes.length)];
        document.getElementById('refran-inicio').textContent = refran.inicio;

        const opciones = [refran.remate];
        while(opciones.length < 4) {
            const randomRemate = rematesDisponibles[Math.floor(Math.random() * rematesDisponibles.length)];
            if(!opciones.includes(randomRemate)) opciones.push(randomRemate);
        }
        opciones.sort(() => Math.random() - 0.5);

        opciones.forEach(opcion => {
            const boton = document.createElement('div');
            boton.className = 'opcion-remate';
            boton.textContent = opcion;
            boton.onclick = () => verificarRespuesta(opcion === refran.remate, boton);
            opcionesContainer.appendChild(boton);
        });

        respuestaCorrecta = refran.remate;
    }

    function verificarRespuesta(esCorrecta, elemento) {
        const opciones = document.querySelectorAll('.opcion-remate');
        opciones.forEach(opcion => opcion.style.pointerEvents = 'none');

        if(esCorrecta) {
            elemento.classList.add('correcto');
            showToast('¬°Correcto! üéâ', 2000);
            document.getElementById('nuevo-btn').style.display = 'block';
        } else {
            elemento.classList.add('incorrecto');
            showToast('‚ùå Incorrecto - La respuesta era: ' + respuestaCorrecta, 3000);
            setTimeout(() => {
                opciones.forEach(opcion => {
                    if(opcion.textContent === respuestaCorrecta) opcion.classList.add('correcto');
                });
            }, 500);
        }
    }

    // Modo Lista
    async function cargarListaRefranes() {
        if(!refranesCargados) {
            const lista = document.getElementById('lista-refranes');
            const refranesUnicos = new Set();
            
            refranes.forEach(refran => {
                const clave = refran.completo
                    .toLowerCase()
                    .normalize("NFD")
                    .replace(/[\u0300-\u036f]/g, "")
                    .replace(/[^a-z√±]/g, "");
                
                if(!refranesUnicos.has(clave)) {
                    refranesUnicos.add(clave);
                    lista.innerHTML += `<li class="refran-item">${refran.completo}</li>`;
                }
            });
            
            document.getElementById('contador').textContent = 
                `Mostrando ${refranesUnicos.size} refranes √∫nicos`;
            refranesCargados = true;
        }
    }

    // Control de modos
    function mostrarModo(modo) {
        document.querySelectorAll('.modo-btn').forEach(btn => btn.classList.remove('activo'));
        document.querySelectorAll('.modo-contenido').forEach(contenido => {
            contenido.classList.remove('activo');
            contenido.style.display = 'none';
        });
        
        const botonActivo = document.querySelector(`[onclick="mostrarModo('${modo}')"]`);
        const contenido = document.getElementById(`modo-${modo}`);
        
        if(botonActivo && contenido) {
            botonActivo.classList.add('activo');
            contenido.classList.add('activo');
            contenido.style.display = 'block';
            
            if(modo === 'lista') cargarListaRefranes();
            if(modo === 'juego' && refranes.length === 0) cargarDatos();
        }
    }

    // Control del men√∫
    document.querySelector('.menu-btn').addEventListener('click', () => {
        const menu = document.querySelector('.menu-contenido');
        menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
    });

    window.addEventListener('click', (e) => {
        if(!e.target.closest('.menu-flotante')) {
            document.querySelector('.menu-contenido').style.display = 'none';
        }
    });

    // Iniciar
    cargarDatos().catch(error => console.error('Error inicial:', error));
</script>
